<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>ArtVision - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo-art">
                        <div class="palette"></div>
                        <div class="brush"></div>
                    </div>
                </div>
                <div class="title-section">
                    <h1>ArtVision</h1>
                    <div class="subtitle">–°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω—ã –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É —Ñ–æ—Ç–æ</div>
                </div>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="container">
            <div class="grid">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –í–≤–æ–¥ -->
                <div class="left-column">
                    <div class="btn-group">
                        <button id="btn" class="btn btn-primary">
                            <span class="btn-icon">üì∏</span> –ö–∞–º–µ—Ä–∞
                        </button>
                        <label class="btn btn-secondary" for="file">
                            <span class="btn-icon">üñºÔ∏è</span> –í—ã–±—Ä–∞—Ç—å —Ö–æ–ª—Å—Ç
                        </label>
                        <input id="file" type="file" accept="image/*" style="display:none">
                    </div>

                    <div class="preview-area" id="previewArea">
                        <div class="preview-placeholder">
                            <div class="easel">
                                <div class="easel-stand"></div>
                                <div class="easel-canvas"></div>
                            </div>
                            <div>—Ö–æ–ª—Å—Ç –ø—É—Å—Ç</div>
                        </div>
                    </div>
                </div>

                <div class="right-column">
                    <div class="card fade-in">
                        <div class="card-icon">üé®</div>
                        <h1 class="card-title">–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω—ã</h1>
                        <div class="card-description">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–º–µ—Ä—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è</div>
                    </div>

                    <div class="threshold-section">
                        <div class="threshold-header">
                            <span class="threshold-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</span>
                            <span class="threshold-value" id="thVal">65%</span>
                        </div>
                        <input id="th" type="range" min="30" max="95" value="65" class="threshold-slider">
                        <div class="threshold-hint">
                            –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —É–≤–µ—Ä–µ–Ω–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–∏–Ω—ã (–Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞), —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ <strong>¬´–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞¬ª</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
            <div class="card fade-in">
                <div class="card-header">
                    <div class="card-icon">üîç</div>
                    <h2 class="card-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã</h2>
                </div>

                <div class="status" id="status">
                    üé® –ó–∞–≥—Ä—É–∂–∞—é —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å...
                </div>

                <div class="verdict" id="verdict" style="display:none">
                    <div class="verdict-title">–í—ã–≤–æ–¥ –ø–æ–º–æ—â–Ω–∏–∫–∞:</div>
                    <div class="verdict-result" id="verdictResult"></div>
                    <div class="verdict-reason" id="verdictReason"></div>
                </div>

                <div id="probs"></div>
            </div>
        </div>
    </div>

    <!-- TFJS + TeachableMachine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            let THRESHOLD = 0.65;
            const MARGIN_MIN = 0.10;
            const ENTROPY_MAX = 1.2;

            // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const btn = document.getElementById('btn');
            const file = document.getElementById('file');
            const previewArea = document.getElementById('previewArea');
            const statusEl = document.getElementById('status');
            const verdictEl = document.getElementById('verdict');
            const verdictResult = document.getElementById('verdictResult');
            const verdictReason = document.getElementById('verdictReason');
            const probsEl = document.getElementById('probs');
            const thSlider = document.getElementById('th');
            const thValue = document.getElementById('thVal');

            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
            if (!btn || !file || !previewArea || !statusEl || !verdictEl || !verdictResult || !verdictReason || !probsEl || !thSlider || !thValue) {
                console.error('–ù–µ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞
            thSlider.addEventListener('input', e => {
                THRESHOLD = Number(e.target.value) / 100;
                thValue.textContent = `${e.target.value}%`;
            });

            // –ú–æ–¥–µ–ª—å –∏ –∫–∞–º–µ—Ä–∞
            let model, webcam, raf;
            let currentFacingMode = 'user'; // 'user' - —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è, 'environment' - –∑–∞–¥–Ω—è—è

            // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
            (async () => {
                try {
                    statusEl.innerHTML = 'üîÑ –ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π...';
                    model = await tmImage.load(`model.json`, `metadata.json`);
                    statusEl.innerHTML = '‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞–º–µ—Ä—É';
                } catch (e) {
                    statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏';
                    console.error('LOAD ERROR:', e);
                }
            })();

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
            function renderBars(preds) {
                if (!probsEl) return;
                
                probsEl.innerHTML = '';
                preds.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'probability-item';
                    
                    const label = document.createElement('div');
                    label.className = 'probability-label';
                    label.textContent = p.className;
                    
                    const bar = document.createElement('div');
                    bar.className = 'probability-bar';
                    
                    const fill = document.createElement('div');
                    fill.className = 'probability-fill';
                    fill.style.width = `${(p.probability * 100).toFixed(1)}%`;
                    bar.appendChild(fill);
                    
                    const value = document.createElement('div');
                    value.className = 'probability-value';
                    value.textContent = `${(p.probability * 100).toFixed(1)}%`;
                    
                    item.append(label, bar, value);
                    probsEl.appendChild(item);
                });
            }

            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            function renderVerdict(preds) {
                if (!verdictEl || !verdictResult || !verdictReason) return;
                
                const sorted = [...preds].sort((a, b) => b.probability - a.probability);
                const top1 = sorted[0];
                const top2 = sorted[1] || { probability: 0 };

                const belowThreshold = top1.probability < THRESHOLD;
                const margin = top1.probability - top2.probability;
                const smallMargin = margin < MARGIN_MIN;

                let H = 0;
                for (const p of preds) {
                    if (p.probability > 0) H += -p.probability * Math.log(p.probability);
                }
                const highEntropy = H > ENTROPY_MAX;

                verdictEl.style.display = 'block';

                if (belowThreshold || smallMargin || highEntropy) {
                    const reasons = [];
                    if (belowThreshold) reasons.push(`—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–∏–∂–µ ${Math.round(THRESHOLD * 100)}%`);
                    if (smallMargin) reasons.push(`–º–∞–ª—ã–π —Ä–∞–∑—Ä—ã–≤ —Å –¥—Ä—É–≥–∏–º —Å—Ç–∏–ª–µ–º`);
                    if (highEntropy) reasons.push(`–Ω–∏–∑–∫–∞—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–∏–ª—è`);

                    verdictResult.textContent = '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞';
                    verdictResult.style.color = 'var(--warning)';
                    verdictReason.textContent = `–ü—Ä–∏—á–∏–Ω—ã: ${reasons.join(', ')}`;
                    verdictEl.style.background = 'linear-gradient(135deg, #fef5e7, #fed7aa)';
                    verdictEl.style.borderLeftColor = 'var(--warning)';
                } else {
                    verdictResult.textContent = `${top1.className} (${(top1.probability * 100).toFixed(1)}%)`;
                    verdictResult.style.color = 'var(--success)';
                    verdictReason.textContent = `–í—ã—Å–æ–∫–∞—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω—ã, —Ä–∞–∑—Ä—ã–≤ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º: ${(margin * 100).toFixed(1)}%`;
                    verdictEl.style.background = 'linear-gradient(135deg, #f0fff4, #c6f6d5)';
                    verdictEl.style.borderLeftColor = 'var(--success)';
                }
            }

            // –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
            async function predictOn(el) {
                if (!model) return;
                try {
                    const preds = await model.predict(el);
                    if (statusEl) statusEl.style.display = 'none';
                    renderVerdict(preds);
                    renderBars(preds);
                } catch (e) {
                    if (statusEl) {
                        statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                        statusEl.style.display = 'block';
                    }
                    console.error('PREDICT ERROR:', e);
                }
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
            file.onchange = e => {
                const f = e.target.files?.[0];
                if (!f) return;

                if (raf) cancelAnimationFrame(raf);
                if (webcam) webcam.stop();

                const url = URL.createObjectURL(f);
                previewArea.innerHTML = `<img src="${url}" alt="Preview" style="width:100%;height:100%;object-fit:cover;">`;

                const img = previewArea.querySelector('img');
                img.onload = async () => {
                    await predictOn(img);
                    URL.revokeObjectURL(url);
                };
            };

            // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
            function switchCamera() {
                if (webcam && webcam.webcam) {
                    currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                    stopCamera();
                    startCamera();
                }
            }

            // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
            function stopCamera() {
                if (raf) {
                    cancelAnimationFrame(raf);
                    raf = null;
                }
                if (webcam) {
                    webcam.stop();
                    webcam = null;
                }
            }

            // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
            async function startCamera() {
                if (!model) return;
                try {
                    if (statusEl) {
                        statusEl.innerHTML = 'üì∏ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –∫–∞–º–µ—Ä—É...';
                        statusEl.style.display = 'block';
                    }

                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –∫–∞–º–µ—Ä—ã
                    const flip = currentFacingMode === 'user';
                    
                    webcam = new tmImage.Webcam(400, 400, flip);
                    
                    // –ü–µ—Ä–µ–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
                    await webcam.setup({
                        facingMode: currentFacingMode,
                        resizeWidth: 400,
                        resizeHeight: 400
                    });
                    
                    await webcam.play();

                    previewArea.innerHTML = '';
                    previewArea.appendChild(webcam.canvas);

                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
                    if (!document.getElementById('switchCameraBtn')) {
                        const switchBtn = document.createElement('button');
                        switchBtn.id = 'switchCameraBtn';
                        switchBtn.className = 'btn btn-secondary';
                        switchBtn.innerHTML = 'üîÑ –ö–∞–º–µ—Ä–∞';
                        switchBtn.style.marginTop = '10px';
                        switchBtn.onclick = switchCamera;
                        previewArea.parentNode.insertBefore(switchBtn, previewArea.nextSibling);
                    }

                    if (statusEl) statusEl.style.display = 'none';
                    loop();
                } catch (e) {
                    if (statusEl) statusEl.innerHTML = '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                    console.error(e);
                }
            }

            // –¶–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
            async function loop() {
                if (webcam) {
                    webcam.update();
                    await predictOn(webcam.canvas);
                    raf = requestAnimationFrame(loop);
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –∫–∞–º–µ—Ä—ã
            btn.onclick = startCamera;

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            window.addEventListener('beforeunload', () => {
                stopCamera();
            });
        });
    </script>
</body>
</html>